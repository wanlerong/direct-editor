---
description: 
globs: src/components/table.ts
alwaysApply: false
---
# 表格组件设计

## 核心设计
- 基于 HTML 原生表格元素构建(table, tr, td)
- 使用 TableManager 类管理表格相关操作
- 支持完整的表格编辑功能：创建、删除、行列操作、单元格合并拆分
- 支持矩形区域选择和智能单元格操作

## 单元格选择实现
- 通过mousedown、mousemove和mouseup事件实现框选
- 使用二维矩阵记录单元格位置和占用情况
- 处理选择端点为colspan和rowspan合并单元格时的选择逻辑, 最大化矩形范围
- 框选时按照矩形区域选择单元格
- 支持单选和多选模式
- **使用绝对定位overlay显示选择状态，避免DOM变化和协作冲突**

## 合并单元格原则
- 只有完全包含在选区内的单元格才能被合并
- 当选区与某单元格有交集但未完全包含该单元格时，禁用合并功能
- 合并操作保留第一个单元格内容，删除其他单元格
- 处理特殊情况：全行合并、全列合并、全表合并

## 选区计算逻辑
1. `calculateCellDetails()`: 计算每个单元格的实际位置范围(考虑合并单元格)
2. `getCellsRange()`: 计算两个单元格间的矩形选区范围
3. `hasPartiallyOverlappingCells()`: 检测是否有部分重叠单元格，根据结果决定是否启用合并功能
4. `updateSelectedCells()`: 更新选中单元格的视觉状态

## 光标管理
- `setCursorToFirstCell()`: 设置光标到表格第一个单元格
- 表格删除后智能光标定位
- 行列操作后的光标重定位

## 用户体验
- 提供直观的单元格操作菜单
- 合并单元格时自动禁用不合理的操作
- 通过视觉反馈(高亮)显示选中的单元格
- 菜单位置智能调整，避免超出视窗边界
- 支持键盘和鼠标操作

## 协同编辑支持
- 使用绝对定位overlay显示表格选择状态，完全避免DOM变化
- 选择状态仅本地显示，不触发MutationObserver，无需同步给协作者
- 确保表格操作的协作一致性，overlay方案消除了UI状态的协作干扰 